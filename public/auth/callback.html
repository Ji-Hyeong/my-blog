<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auth Callback</title>
    <link rel="icon" href="/favicon.svg" />
    <style>
      body {
        margin: 0;
        font-family: "IBM Plex Sans KR", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        background: #f8f2e8;
        color: #1d1b16;
      }
      .container {
        width: min(720px, 92vw);
        margin: 0 auto;
        padding: 48px 0;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e6ddcf;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 12px 24px rgba(30, 24, 16, 0.1);
      }
      .title {
        font-size: 24px;
        margin-bottom: 10px;
      }
      .desc {
        color: #5e5a52;
        line-height: 1.7;
      }
      .actions {
        margin-top: 14px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid #e6ddcf;
        background: #fffaf2;
        color: #1d1b16;
        cursor: pointer;
        font-size: 13px;
        text-decoration: none;
      }
      .btn:hover {
        background: #2f6b5f;
        color: #ffffff;
      }
    </style>
    <script src="/supabase-config.js"></script>
    <script src="/supabase.js"></script>
  </head>
  <body>
    <main class="container">
      <section>
        <h1 class="title">로그인 처리 중…</h1>
        <p class="desc">잠시만 기다려주세요.</p>
        <div class="card" id="callbackStatus" style="margin-top: 24px;">
          세션을 확인하고 있습니다.
        </div>
      </section>
    </main>

    <script>
      /*
        OAuth callback handler.

        - PKCE(code)와 Implicit(token) 플로우 모두 지원합니다.
        - 성공 시 returnTo 해시 경로로 복귀합니다.
      */
      (async () => {
        const status = document.getElementById('callbackStatus');
        const client = await window.JH_SUPABASE.getSupabaseClient();

        try {
          const returnTo = localStorage.getItem('jh_return_to') || '/#/';
          const url = new URL(window.location.href);
          const code = url.searchParams.get('code');

          if (code) {
            status.textContent = '세션 교환 중…';
            const { error } = await client.auth.exchangeCodeForSession(code);
            if (error) {
              console.warn('exchangeCodeForSession failed:', error);
            }
          }

          status.textContent = '세션 확인 중…';
          const { data: fromUrl, error: fromUrlError } =
            await client.auth.getSessionFromUrl({ storeSession: true });
          if (fromUrlError) {
            console.warn('getSessionFromUrl failed:', fromUrlError);
          }

          const { data: fromStore } = await client.auth.getSession();
          const session = fromUrl?.session || fromStore?.session || null;

          if (!session) {
            status.innerHTML = `
              <div>
                <strong>로그인에 실패했습니다.</strong>
                <p class="desc" style="margin-top: 8px;">
                  인증 정보(code/token)를 받지 못해 세션을 만들 수 없습니다.
                </p>
                <div class="actions">
                  <button class="btn" id="retryLogin">다시 로그인</button>
                  <a class="btn" href="/#/">홈으로</a>
                </div>
              </div>
            `;

            const retry = document.getElementById('retryLogin');
            if (retry) {
              retry.addEventListener('click', async () => {
                try {
                  await window.JH_SUPABASE.signInWithGoogle({ returnTo });
                } catch (e) {
                  alert('로그인에 실패했습니다. 잠시 후 다시 시도해 주세요.');
                }
              });
            }
            return;
          }

          localStorage.removeItem('jh_return_to');
          status.textContent = '완료. 이동 중…';
          setTimeout(() => window.location.replace(returnTo), 50);
        } catch (error) {
          console.warn('OAuth callback error:', error);
          status.innerHTML = `
            <div>
              <strong>로그인 처리 중 오류가 발생했습니다.</strong>
              <p class="desc" style="margin-top: 8px;">잠시 후 다시 시도해 주세요.</p>
              <div class="actions">
                <button class="btn" id="retryLogin2">다시 로그인</button>
                <a class="btn" href="/#/">홈으로</a>
              </div>
            </div>
          `;

          const retry = document.getElementById('retryLogin2');
          if (retry) {
            retry.addEventListener('click', async () => {
              try {
                await window.JH_SUPABASE.signInWithGoogle({ returnTo });
              } catch (e) {
                alert('로그인에 실패했습니다. 잠시 후 다시 시도해 주세요.');
              }
            });
          }
        }
      })();
    </script>
  </body>
</html>
