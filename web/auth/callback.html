<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Supabase 설정(기본값은 assets/supabase.js에 있음). 필요하면 meta로 override -->
    <meta name="supabase-url" content="" />
    <meta name="supabase-anon-key" content="" />
    <meta name="writer-email" content="" />
    <title>Auth Callback</title>
    <link rel="stylesheet" href="../assets/style.css" />
  </head>
  <body>
    <main class="container page">
      <section class="reveal" data-delay="0.05">
        <h1 class="page-title">로그인 처리 중…</h1>
        <p class="page-desc">잠시만 기다려주세요.</p>
        <div class="card" id="callbackStatus" style="margin-top: 24px;">
          세션을 확인하고 있습니다.
        </div>
      </section>
    </main>

    <script src="../assets/app.js"></script>
    <script src="../assets/supabase.js"></script>
    <script>
      /*
        OAuth callback handler.

        Supabase의 OAuth redirect는 환경/설정에 따라 아래 두 가지 형태로 돌아올 수 있습니다.
        - PKCE(code) 플로우: `?code=...`
        - Implicit(토큰) 플로우: `#access_token=...` 같은 hash fragment

        이 페이지의 역할:
        1) URL에 포함된 인증 정보를 세션으로 확정(store)합니다.
        2) 로그인 시작 페이지(returnTo)로 되돌려 보냅니다.

        주의:
        - URL에 아무 파라미터도 없는 경우가 있습니다(설정 오류/차단/사용자 직접 접근 등).
          이 경우에는 원인을 안내하고 “다시 로그인”할 수 있는 버튼을 제공합니다.
      */
      (async () => {
        const status = document.getElementById("callbackStatus");
        const client = await window.JH_SUPABASE.getSupabaseClient();

        try {
          /**
           * UX 정책:
           * - callback 화면이 “에러처럼” 보이지 않도록, 가능한 한 빠르게 원래 페이지로 복귀합니다.
           * - 세션 교환/저장 과정에서 문제가 생기더라도, 사용자는 다시 로그인 버튼을 누를 수 있습니다.
           *
           * 주의:
           * - returnTo는 로그인 시작 시 localStorage에 저장됩니다.
           * - 저장이 없으면 기본 홈으로 이동합니다.
           */
          const returnTo = localStorage.getItem("jh_return_to") || "/index.html";

          const url = new URL(window.location.href);
          const code = url.searchParams.get("code");

          /**
           * 1) PKCE(code) 플로우 처리
           *
           * - query string에 code가 포함되어 있으면 명시적으로 세션 교환을 시도합니다.
           * - 성공하면 storeSession이 이루어져 이후 페이지에서 getSession()으로 읽을 수 있습니다.
           */
          if (code) {
            status.textContent = "세션 교환 중…";
            const { error } = await client.auth.exchangeCodeForSession(code);
            if (error) {
              // 세션 교환이 실패하더라도, UX상 바로 복귀합니다.
              console.warn("exchangeCodeForSession failed:", error);
            }
          }

          /**
           * 2) Implicit(토큰 hash) 또는 Supabase 내부 처리(detectSessionInUrl) 폴백
           *
           * - `getSessionFromUrl`은 hash fragment를 포함한 URL에서 세션을 추출하고 저장할 수 있습니다.
           * - code가 없는 경우에도 이 경로로 세션이 잡힐 수 있습니다.
           */
          status.textContent = "세션 확인 중…";
          const { data: fromUrl, error: fromUrlError } =
            await client.auth.getSessionFromUrl({ storeSession: true });
          if (fromUrlError) {
            // getSessionFromUrl이 실패하더라도, 이미 세션이 저장된 상태일 수 있으므로 아래에서 한 번 더 확인합니다.
            console.warn("getSessionFromUrl failed:", fromUrlError);
          }

          const { data: fromStore } = await client.auth.getSession();
          const session = fromUrl?.session || fromStore?.session || null;

          if (!session) {
            // 세션이 없다면 설정/차단 이슈일 가능성이 높지만, UX상 즉시 원래 화면으로 되돌립니다.
            console.warn("No session detected on callback URL.");
          }

          localStorage.removeItem("jh_return_to");
          status.textContent = "완료. 이동 중…";
          // localStorage flush 및 UI 렌더링을 위한 아주 짧은 지연 후 이동합니다.
          setTimeout(() => window.location.replace(returnTo), 50);
        } catch (error) {
          // 예외가 나더라도 UX상 즉시 복귀합니다.
          console.warn("OAuth callback error:", error);
          const returnTo = localStorage.getItem("jh_return_to") || "/index.html";
          localStorage.removeItem("jh_return_to");
          status.textContent = "이동 중…";
          setTimeout(() => window.location.replace(returnTo), 50);
        }
      })();
    </script>
  </body>
</html>
