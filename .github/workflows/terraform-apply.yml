#
# Terraform PR Apply (comment-driven)
#
# 목적:
# - PR 코멘트로 `/apply`를 남기면 Terraform apply를 실행합니다.
# - “자동 apply”보다 사람이 의도를 명확히 남기고 진행하도록 구성합니다.
#
# 보안:
# - apply는 write 권한 이상 사용자만 가능하도록 가드합니다.
# - fork PR에서는 기본적으로 안전하지 않으므로 apply를 차단합니다.
#

name: terraform-apply

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  id-token: write
  pull-requests: read
  issues: write

concurrency:
  # prod apply는 동시에 1개만 실행되도록 고정 그룹으로 잠급니다.
  group: terraform-apply-prod
  cancel-in-progress: false

jobs:
  apply:
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/apply')
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: infra/terraform/environments/prod

    steps:
      - name: Resolve PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number,
            });

            const commenter = context.payload.comment.user.login;
            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter,
            });

            core.setOutput("head_sha", pr.data.head.sha);
            // PR이 fork에서 올라온 경우, head repo가 base repo와 다릅니다.
            core.setOutput(
              "is_fork",
              pr.data.head.repo.full_name !== pr.data.base.repo.full_name ? "true" : "false"
            );
            core.setOutput("commenter", commenter);
            core.setOutput("permission", perm.data.permission);

      - name: Guard (reject forks)
        if: steps.pr.outputs.is_fork == 'true'
        run: |
          echo "Fork PR은 보안상 apply를 허용하지 않습니다."
          exit 1

      - name: Guard (permission check)
        # 허용 수준: write/maintain/admin
        if: |
          !contains(fromJSON('["write","maintain","admin"]'), steps.pr.outputs.permission)
        run: |
          echo "apply 권한이 없습니다. permission=${{ steps.pr.outputs.permission }}"
          exit 1

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_sha }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform init (remote backend)
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ secrets.TF_STATE_KEY }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"

      - name: Terraform apply
        env:
          TF_VAR_api_image: ${{ secrets.API_IMAGE }}
          TF_VAR_enable_https: ${{ secrets.ENABLE_HTTPS }}
          TF_VAR_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        run: terraform apply -auto-approve

      - name: Comment result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = "${{ job.status }}";
            const body = [
              "### Terraform apply (prod)",
              `- triggered by: @${{ steps.pr.outputs.commenter }}`,
              `- result: **${outcome}**`,
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
